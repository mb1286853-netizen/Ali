"""
Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø§Ø²Ø§Ø± Ø¬Ù†Ú¯
"""

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from keyboards import get_market_keyboard, get_back_keyboard

def register_market_handlers(dp):
    """Ø«Ø¨Øª Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø±"""
    dp.message.register(market_panel, F.text == "ğŸ¦ Ø¨Ø§Ø²Ø§Ø± Ø¬Ù†Ú¯")
    dp.callback_query.register(show_fast_missiles, F.data == "market_fast")
    dp.callback_query.register(show_apocalypse_missiles, F.data == "market_apocalypse")
    dp.callback_query.register(buy_missile, F.data.startswith("buy_"))

# Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§
MISSILES = {
    "fast": [
        {"name": "Ø´Ù‡Ø§Ø¨ (Meteor)", "damage": 50, "price": 200, "level": 1},
        {"name": "ØªÚ¯Ø±Ú¯ (Hailstorm)", "damage": 70, "price": 500, "level": 2},
        {"name": "Ø³ÛŒÙ„ (Torrent)", "damage": 90, "price": 1000, "level": 3},
        {"name": "ØªÙˆÙØ§Ù† (Tempest)", "damage": 110, "price": 2000, "level": 4},
        {"name": "Ø¢Ø°Ø±Ø®Ø´ (Thunderbolt)", "damage": 130, "price": 5000, "level": 5}
    ],
    "apocalypse": [
        {"name": "Ø§Ø±Ù…ØºØ¯Ù† (Armageddon)", "damage": 500, "price": 50000, "gems": 15, "level": 15},
        {"name": "Ø§Ù¾ÙˆÚ©Ø§Ù„ÛŒÙ¾Ø³ (Apocalypse)", "damage": 400, "price": 40000, "gems": 12, "level": 12},
        {"name": "Ø±Ú¯Ù†Ø§Ø±ÙˆÚ© (Ragnarok)", "damage": 350, "price": 35000, "gems": 10, "level": 10},
        {"name": "Ù‡Ø§Ø±Ù…Ø¬Ø¯ÙˆÙ† (Harmagedon)", "damage": 300, "price": 30000, "gems": 8, "level": 8},
        {"name": "Ø¢ØªÙ†Ø§ (Athena)", "damage": 250, "price": 25000, "gems": 5, "level": 6}
    ]
}

async def market_panel(message: Message):
    """Ù…Ù†ÙˆÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¬Ù†Ú¯"""
    text = """
ğŸ¦ **Ø¨Ø§Ø²Ø§Ø± Ø¬Ù†Ú¯**

ğŸ’ **ØªÙˆØ¬Ù‡:** Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ Ø¬Ù… Ù†Ø¯Ø§Ø±Ù†Ø¯!

ğŸ”¥ **Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹:** ÙÙ‚Ø· Ø¨Ø§ Ø³Ú©Ù‡
ğŸ’€ **Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ø¢Ø®Ø±Ø§Ù„Ø²Ù…Ø§Ù†ÛŒ:** Ø³Ú©Ù‡ + Ø¬Ù…

ğŸ¯ **Ø¬Ù… ÙÙ‚Ø· Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯!**
"""
    await message.answer(text, reply_markup=get_market_keyboard())

async def show_fast_missiles(callback: CallbackQuery):
    """Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹"""
    text = """
ğŸ”¥ **Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹**

Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹:
"""
    
    # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    buttons = []
    for missile in MISSILES["fast"]:
        btn_text = f"{missile['name']} - {missile['price']} Ø³Ú©Ù‡"
        btn_data = f"buy_fast_{missile['name']}"
        buttons.append([InlineKeyboardButton(text=btn_text, callback_data=btn_data)])
    
    buttons.append([InlineKeyboardButton(text="â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="main_menu")])
    keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª
    for missile in MISSILES["fast"]:
        text += f"\nâ€¢ **{missile['name']}**"
        text += f"\n  âš¡ Damage: {missile['damage']}"
        text += f"\n  ğŸ’° Ù‚ÛŒÙ…Øª: {missile['price']} Ø³Ú©Ù‡"
        text += f"\n  ğŸ“Š Ø³Ø·Ø­: {missile['level']}\n"
    
    await callback.message.edit_text(text, reply_markup=keyboard)
    await callback.answer()

async def show_apocalypse_missiles(callback: CallbackQuery):
    """Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ø¢Ø®Ø±Ø§Ù„Ø²Ù…Ø§Ù†ÛŒ"""
    text = """
ğŸ’€ **Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ø¢Ø®Ø±Ø§Ù„Ø²Ù…Ø§Ù†ÛŒ**

Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ (Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¬Ù…):
"""
    
    buttons = []
    for missile in MISSILES["apocalypse"]:
        btn_text = f"{missile['name']} - {missile['gems']} Ø¬Ù…"
        btn_data = f"buy_apo_{missile['name']}"
        buttons.append([InlineKeyboardButton(text=btn_text, callback_data=btn_data)])
    
    buttons.append([InlineKeyboardButton(text="â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="main_menu")])
    keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)
    
    for missile in MISSILES["apocalypse"]:
        text += f"\nâ€¢ **{missile['name']}**"
        text += f"\n  â˜ ï¸ Damage: {missile['damage']}"
        text += f"\n  ğŸ’° Ù‚ÛŒÙ…Øª: {missile['price']} Ø³Ú©Ù‡ + {missile['gems']} Ø¬Ù…"
        text += f"\n  ğŸ“Š Ø³Ø·Ø­: {missile['level']}\n"
    
    text += "\nâš ï¸ **Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ Ø¬Ù… Ù†Ø¯Ø§Ø±Ù†Ø¯!**"
    
    await callback.message.edit_text(text, reply_markup=keyboard)
    await callback.answer()

async def buy_missile(callback: CallbackQuery):
    """Ø®Ø±ÛŒØ¯ Ù…ÙˆØ´Ú©"""
    from main import db
    
    data = callback.data
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    
    if not user:
        await callback.answer("âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†!", show_alert=True)
        return
    
    # ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ù…ÙˆØ´Ú©
    if data.startswith("buy_fast_"):
        missile_name = data.replace("buy_fast_", "")
        missile_list = MISSILES["fast"]
    elif data.startswith("buy_apo_"):
        missile_name = data.replace("buy_apo_", "")
        missile_list = MISSILES["apocalypse"]
    else:
        await callback.answer("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÛŒØ¯!", show_alert=True)
        return
    
    # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…ÙˆØ´Ú©
    missile_data = None
    for missile in missile_list:
        if missile["name"] == missile_name:
            missile_data = missile
            break
    
    if not missile_data:
        await callback.answer("âŒ Ù…ÙˆØ´Ú© ÛŒØ§ÙØª Ù†Ø´Ø¯!", show_alert=True)
        return
    
    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø³Ø·Ø­
    if user[6] < missile_data["level"]:
        await callback.answer(f"âŒ Ø³Ø·Ø­ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª! Ù†ÛŒØ§Ø²: Ø³Ø·Ø­ {missile_data['level']}", show_alert=True)
        return
    
    # Ú†Ú© Ú©Ø±Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹
    if user[3] < missile_data["price"]:
        await callback.answer(f"âŒ Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª! Ù†ÛŒØ§Ø²: {missile_data['price']}", show_alert=True)
        return
    
    if "gems" in missile_data and user[4] < missile_data["gems"]:
        await callback.answer(f"âŒ Ø¬Ù… Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª! Ù†ÛŒØ§Ø²: {missile_data['gems']}", show_alert=True)
        return
    
    # Ø®Ø±ÛŒØ¯ Ù…ÙˆØ´Ú©
    if "gems" in missile_data:
        # Ù…ÙˆØ´Ú© Ø¢Ø®Ø±Ø§Ù„Ø²Ù…Ø§Ù†ÛŒ
        db.update_coins(user_id, -missile_data["price"])
        db.update_gems(user_id, -missile_data["gems"])
        cost_text = f"{missile_data['price']} Ø³Ú©Ù‡ + {missile_data['gems']} Ø¬Ù…"
    else:
        # Ù…ÙˆØ´Ú© Ø³Ø±ÛŒØ¹
        db.update_coins(user_id, -missile_data["price"])
        cost_text = f"{missile_data['price']} Ø³Ú©Ù‡"
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…ÙˆØ´Ú© Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    db.add_missile(user_id, missile_name)
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯
    user = db.get_user(user_id)
    
    text = f"""
âœ… **Ø®Ø±ÛŒØ¯ Ù…ÙˆÙÙ‚!**

ğŸ¯ **{missile_name}** Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯!
âš¡ Damage: {missile_data['damage']}
ğŸ’° Ù‡Ø²ÛŒÙ†Ù‡: {cost_text}
ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: 1 Ø¹Ø¯Ø¯

ğŸ’ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡:
â€¢ Ø³Ú©Ù‡: {user[3]:,}
â€¢ Ø¬Ù…: {user[4]:,}
"""
    
    await callback.message.edit_text(text, reply_markup=get_back_keyboard())
    await callback.answer("âœ… Ø®Ø±ÛŒØ¯ Ø´Ø¯!")
